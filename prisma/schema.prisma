generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String              @id @default(uuid())
  userId       String              @unique
  createdAt    DateTime            @default(now())
  lastUpdated  DateTime            @updatedAt
  angerEvents  AngerEvent[]
  angerStats   AngerStats?
  patterns     CodePattern[]
  interactions InteractionRecord[]
  mistakes     MistakeRecord[]

  @@index([userId])
}

model MistakeRecord {
  id        String   @id @default(uuid())
  userId    String
  errorType String
  message   String
  file      String
  line      Int
  timestamp DateTime @default(now())
  count     Int      @default(1)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, errorType])
  @@index([userId, timestamp])
  @@index([userId, file, line])
}

model CodePattern {
  id          String   @id @default(uuid())
  userId      String
  name        String
  description String
  frequency   Int
  lastSeen    DateTime @default(now())
  examples    String[]
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, name])
  @@index([userId, frequency])
  @@index([userId, lastSeen])
}

model InteractionRecord {
  id         String   @id @default(uuid())
  userId     String
  type       String
  message    String
  timestamp  DateTime @default(now())
  angerLevel Int?
  errorCount Int?
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, type])
  @@index([userId, timestamp])
}

model AngerEvent {
  id        String   @id @default(uuid())
  userId    String
  level     Int
  timestamp DateTime @default(now())
  trigger   String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, level])
  @@index([userId, timestamp])
}

model AngerStats {
  id           String   @id @default(uuid())
  userId       String   @unique
  totalDeaths  Int      @default(0)
  highestLevel Int      @default(0)
  averageLevel Float    @default(0)
  levelCounts  Json
  timeAtLevel  Json
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}
